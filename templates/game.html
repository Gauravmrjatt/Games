{% extends "base.html" %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-white">{{ game.title }}</h1>
            <p class="text-gray-400 mt-2">{{ game.description }}</p>
        </div>
        <div class="text-right">
            <p class="text-sm text-gray-400">Your High Score</p>
            <p class="text-2xl font-bold text-indigo-400">
                {% if user_high_score %}
                    {{ user_high_score }}
                {% else %}
                    0
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Game Container -->
    <div class="relative rounded-xl overflow-hidden shadow-2xl border-4 border-gray-800 bg-gray-900 ring-4 ring-indigo-900 ring-opacity-50">
        <!-- Arcade Header -->
        <div class="bg-gray-800 px-4 py-2 flex justify-between items-center border-b border-gray-700">
            <div class="flex space-x-2">
                <div class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                <div class="w-3 h-3 rounded-full bg-green-500"></div>
            </div>
            <span class="text-xs font-mono text-gray-400">PLAYING: {{ game.title|upper }}</span>
            <div class="text-xs font-mono text-green-400">STATUS: ACTIVE</div>
        </div>

        <div class="bg-black relative" style="min-height: 500px; display: flex; align-items: center; justify-content: center; background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;">
            <div id="game-container" class="w-full h-full relative z-10">
                <!-- Game canvas or elements will be injected here -->
                <p class="text-indigo-500 text-center absolute inset-0 flex items-center justify-center pointer-events-none animate-pulse" id="loading-text">INITIALIZING SYSTEM...</p>
            </div>
            
            <!-- Game Over Modal (Hidden by default) -->
            <div id="game-over-modal" class="hidden absolute inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 backdrop-blur-sm transition-all duration-300">
                <div class="bg-gray-800 p-8 rounded-xl text-center border-2 border-indigo-500 shadow-2xl max-w-sm w-full mx-4 transform scale-100">
                    <h2 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-yellow-500 mb-2">GAME OVER</h2>
                    <div class="my-6 py-4 bg-gray-900 rounded-lg">
                        <p class="text-gray-400 text-sm uppercase tracking-wider mb-1">Final Score</p>
                        <p class="text-5xl font-mono text-white" id="final-score">0</p>
                    </div>
                    <div class="flex flex-col space-y-3">
                        <button onclick="restartGame()" class="w-full py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-lg font-bold shadow-lg transform hover:-translate-y-1 transition-all">
                            PLAY AGAIN
                        </button>
                        <a href="{{ url_for('home') }}" class="w-full py-3 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-bold transition-colors">
                            EXIT TO MENU
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-8">
        <h3 class="text-xl font-bold text-white mb-4">Top Scores</h3>
        <div class="bg-gray-800 shadow overflow-hidden sm:rounded-md border border-gray-700">
            <ul class="divide-y divide-gray-700">
                {% for score in top_scores %}
                <li class="px-4 py-4 sm:px-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <span class="text-gray-400 w-8 font-mono">{{ loop.index }}.</span>
                            <p class="text-sm font-medium text-indigo-300 truncate">
                                {{ score.player.username }}
                            </p>
                        </div>
                        <div class="flex-shrink-0">
                            <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                {{ score.score }}
                            </p>
                        </div>
                    </div>
                </li>
                {% else %}
                <li class="px-4 py-4 text-center text-gray-500">No scores yet. Be the first!</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<script>
    const GAME_ID = {{ game.id }};
    const SUBMIT_SCORE_URL = "{{ url_for('submit_score') }}";
    
    // Helper for game scripts to submit score
    window.submitGameScore = async function(score) {
        try {
            const response = await fetch(SUBMIT_SCORE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': "{{ csrf_token() if csrf_token else '' }}" // Handle CSRF if implemented
                },
                body: JSON.stringify({
                    game_id: GAME_ID,
                    score: score
                })
            });
            
            const data = await response.json();
            if (data.success) {
                console.log('Score submitted successfully');
                showGameOver(score);
            } else {
                console.error('Failed to submit score:', data.message);
                alert('Failed to save score: ' + data.message);
                showGameOver(score);
            }
        } catch (error) {
            console.error('Error submitting score:', error);
            showGameOver(score);
        }
    };

    function showGameOver(score) {
        document.getElementById('final-score').innerText = score;
        document.getElementById('game-over-modal').classList.remove('hidden');
    }

    function restartGame() {
        document.getElementById('game-over-modal').classList.add('hidden');
        if (window.initGame) {
            window.initGame();
        } else {
            window.location.reload();
        }
    }
</script>

<!-- Load the game script -->
<script src="{{ url_for('static', filename='games/' + game.script_file) }}"></script>
{% endblock %}